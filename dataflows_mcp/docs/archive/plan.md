# A股数据流MCP服务改造计划

## 📋 项目概述

将现有的 `dataflows` 数据流模块改造为符合MCP（Model Context Protocol）标准的服务，使其能够被各种AI工具和客户端调用。

### 🎯 改造目标
- 保持所有现有功能不变
- 符合MCP协议规范
- 移除CLI输出依赖
- 改进架构设计
- 支持异步处理

### 📁 项目结构
```
dataflows_mcp/
├── core/           # 改造后的核心功能模块
├── tools/          # MCP工具封装
├── server/         # MCP服务器实现
├── tests/          # 测试套件
├── plan.md         # 本文件 - 详细改造计划
└── task.md         # 可执行任务清单
```

## 🔄 改造阶段划分

### 阶段一：核心功能解耦（预计：1-2周）
**目标**：移除CLI依赖，重构单例模式，标准化错误处理

#### 1.1 移除CLI输出依赖
- **问题**：当前代码重度依赖 `utils.cli_output`
- **解决方案**：替换为标准日志系统
- **改造文件**：所有core目录下的文件

#### 1.2 重构单例模式
- **问题**：全局单例在并发环境下不安全
- **解决方案**：改为工厂函数模式
- **改造文件**：`akshare_client.py`, `a_share_technical.py`

#### 1.3 标准化错误处理
- **问题**：直接调用 `output.fatal()` 退出程序
- **解决方案**：抛出自定义异常
- **改造文件**：所有core目录下的文件

### 阶段二：MCP工具定义和封装（预计：1周）
**目标**：创建MCP工具接口，封装核心功能

#### 2.1 创建工具定义
- 定义所有MCP工具的输入输出schema
- 创建工具描述文档

#### 2.2 实现工具封装类
- 创建 `MCPTools` 类封装所有工具
- 添加异步支持
- 统一错误处理

### 阶段三：MCP服务器实现（预计：1周）
**目标**：实现完整的MCP服务器

#### 3.1 创建MCP服务器
- 实现MCP协议要求的接口
- 配置工具路由
- 实现结果格式化

#### 3.2 创建启动脚本
- 创建便捷的启动方式
- 配置依赖管理

### 阶段四：测试和验证（预计：3-5天）
**目标**：确保改造后功能正确性

#### 4.1 功能测试
- 验证所有功能与改造前一致
- 测试错误处理机制

#### 4.2 集成测试
- 测试MCP协议兼容性
- 验证工具调用流程

#### 4.3 性能测试
- 测试并发性能
- 验证缓存机制

## 🔧 技术方案详情

### 核心改造点

#### 1. 日志系统替换
```python
# 改造前
output.print(f"获取 {code} K线数据")
output.fatal(f"获取失败: {error}")

# 改造后
logger.info(f"获取 {code} K线数据")
raise DataFlowError(f"获取失败: {error}")
```

**改造原因**：
- CLI输出不适合服务环境
- 服务需要异常传播而非直接退出
- 标准化日志便于监控

**优缺点**：
- ✅ 标准化日志格式
- ✅ 支持日志级别控制
- ✅ 更好的错误处理
- ❌ 失去彩色输出
- ❌ 需要修改调用方

#### 2. 单例模式重构
```python
# 改造前
_default_client = None
def get_client():
    global _default_client
    if _default_client is None:
        _default_client = AkshareClient()
    return _default_client

# 改造后
class DataFlowFactory:
    def create_client(self):
        return AkshareClient()
```

**改造原因**：
- 单例模式在并发环境下不安全
- 工厂模式支持更好的测试和配置
- 保持功能不变但改善架构

**优缺点**：
- ✅ 更好的并发安全性
- ✅ 支持依赖注入测试
- ✅ 保持接口兼容性
- ❌ 需要修改实例获取方式

#### 3. 错误处理标准化
```python
# 改造前
try:
    # 业务逻辑
    return {'data': data, 'error': None}
except Exception as e:
    output.fatal(f"失败: {str(e)}")

# 改造后
try:
    # 业务逻辑
    return {'data': data, 'error': None}
except Exception as e:
    logger.error(f"失败: {str(e)}")
    raise DataFlowError(f"业务失败: {str(e)}")
```

**改造原因**：
- 服务环境需要异常传播
- 统一的错误处理便于监控
- 支持错误恢复机制

**优缺点**：
- ✅ 更好的错误传播
- ✅ 支持错误恢复
- ✅ 便于监控分析
- ❌ 需要调用方处理异常

### MCP工具定义

#### 核心工具列表
1. **get_stock_kline** - 获取K线数据
2. **get_stock_realtime** - 获取实时行情
3. **get_technical_indicator** - 计算技术指标
4. **get_limit_up_stocks** - 获取涨停股数据
5. **get_stock_financials** - 获取财务数据
6. **get_stock_news** - 获取新闻数据
7. **get_stock_comment_*** - 获取千股千评数据

#### 工具Schema示例
```json
{
    "name": "get_stock_kline",
    "description": "获取股票K线数据（OHLCV），支持多种时间周期",
    "inputSchema": {
        "type": "object",
        "properties": {
            "code": {"type": "string", "description": "股票代码"},
            "lookback_days": {"type": "integer", "default": 60},
            "period": {"type": "string", "enum": ["daily", "weekly", "monthly"]}
        },
        "required": ["code"]
    }
}
```

## 🚀 实施策略

### 渐进式改造
1. **先解耦**：移除CLI依赖，保持业务逻辑不变
2. **再封装**：创建MCP工具接口
3. **后集成**：实现MCP服务器
4. **最后测试**：全面验证功能正确性

### 风险控制
- 每个阶段完成后进行功能验证
- 保持与原始功能的对比测试
- 逐步替换，避免大规模重构

### 质量保证
- 为每个改造的功能编写测试
- 确保MCP协议兼容性
- 验证并发安全性

## 📊 成功标准

### 功能标准
- [ ] 所有现有功能与改造前一致
- [ ] 错误处理机制正常工作
- [ ] 数据格式保持不变

### 技术标准
- [ ] 符合MCP协议规范
- [ ] 支持异步处理
- [ ] 日志系统正常工作
- [ ] 测试覆盖率达到80%以上

### 性能标准
- [ ] 单次请求响应时间<5秒
- [ ] 支持10个并发请求
- [ ] 内存使用在合理范围内

## 📅 时间安排

| 阶段 | 开始时间 | 结束时间 | 负责人 | 状态 |
|------|----------|----------|--------|------|
| 阶段一：核心解耦 | 2025-10-10 | 2025-10-24 | 开发团队 | 待开始 |
| 阶段二：工具封装 | 2025-10-24 | 2025-10-31 | 开发团队 | 待开始 |
| 阶段三：服务器实现 | 2025-10-31 | 2025-11-07 | 开发团队 | 待开始 |
| 阶段四：测试验证 | 2025-11-07 | 2025-11-12 | 测试团队 | 待开始 |

## 🔗 依赖关系

### 技术依赖
- Python 3.8+
- mcp >= 1.0.0
- akshare >= 1.10.0
- pandas >= 2.0.0
- stockstats >= 0.4.0

### 外部依赖
- AkShare数据源稳定性
- 网络连接可靠性

## 📝 更新记录

| 日期 | 版本 | 修改内容 | 修改人 |
|------|------|----------|--------|
| 2025-10-10 | 1.0 | 创建初始改造计划 | Claude |

---

**备注**：本计划将根据实际实施情况进行调整，具体任务执行情况请参考 `task.md` 文件。